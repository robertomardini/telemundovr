<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>VR Market with A-Frame</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  </head>
  <body>
    <a-scene>
      <!-- Camera with cursor for VR interaction -->
      <a-entity camera look-controls>
        <a-cursor fuse="true" fuse-timeout="500"></a-cursor>
      </a-entity>

      <!-- Floor -->
      <a-plane rotation="-90 0 0" width="30" height="30" color="#7BC8A4"></a-plane>

      <!-- Container for all aisles -->
      <a-entity id="market" position="-10 0 -10"></a-entity>
    </a-scene>

    <script>
      // Layout parameters
      const NUM_AISLES    = 3;    // number of aisles
      const AISLE_SPACING = 8;    // space between aisles on X axis
      const AISLE_LENGTH  = 20;   // length of each aisle on Z axis
      const ITEM_SPACING  = 1.2;  // space between items on the shelf

      // Shelf heights (Y positions)
      const SHELF_HEIGHTS = [
        1.0,  // lower shelf
        1.8,  // middle shelf
        2.6   // upper shelf
      ];

      // URL of your Google Sheet published as TSV
      const SHEET_URL = 'https://docs.google.com/spreadsheets/d/.../pub?output=tsv';

      // Fetch and parse the sheet into an array of product objects
      fetch(SHEET_URL)
        .then(response => response.text())
        .then(text => {
          const lines   = text.trim().split('\n');
          const headers = lines[0].split('\t');
          return lines.slice(1).map(line => {
            const cols = line.split('\t');
            const item = {};
            headers.forEach((header, i) => item[header] = cols[i]);
            return item;
          });
        })
        .then(products => {
          const marketEl = document.getElementById('market');

          // Generate each aisle
          for (let aisleIndex = 0; aisleIndex < NUM_AISLES; aisleIndex++) {
            const offsetX = aisleIndex * AISLE_SPACING;

            ['left', 'right'].forEach(side => {
              const direction = side === 'left' ? -1 : 1;
              const shelfGroup = document.createElement('a-entity');
              shelfGroup.setAttribute('position', `${offsetX} 0 ${-AISLE_LENGTH/2}`);
              marketEl.appendChild(shelfGroup);

              // Create 3 shelves at different heights
              SHELF_HEIGHTS.forEach(shelfY => {
                // Shelf base
                const shelf = document.createElement('a-box');
                shelf.setAttribute('width', AISLE_LENGTH);
                shelf.setAttribute('height', 0.1);
                shelf.setAttribute('depth', 0.5);
                shelf.setAttribute('position', `${direction * 2.5} ${shelfY} 0`);
                shelf.setAttribute('color', '#CCCCCC');
                shelfGroup.appendChild(shelf);

                // Populate shelf with products
                products.forEach((prod, index) => {
                  const columnsPerShelf = Math.floor(AISLE_LENGTH / ITEM_SPACING);
                  const zPos = (index % columnsPerShelf) * ITEM_SPACING - (AISLE_LENGTH/2) + ITEM_SPACING/2;
                  const xPos = direction * 2.5;

                  // Product image
                  const img = document.createElement('a-image');
                  img.setAttribute('src', prod.Image_URL);
                  img.setAttribute('width', '0.8');
                  img.setAttribute('height', '0.8');
                  img.setAttribute('position', `${xPos} ${shelfY + 0.5} ${zPos}`);
                  img.className = 'product';
                  img.dataset.cartUrl = prod.AddToCart_URL;
                  shelfGroup.appendChild(img);

                  // Product title
                  const titleText = document.createElement('a-text');
                  titleText.setAttribute('value', prod.Title);
                  titleText.setAttribute('width', '2');
                  titleText.setAttribute('position', `${xPos} ${shelfY - 0.1} ${zPos}`);
                  shelfGroup.appendChild(titleText);
                });
              });
            });
          }

          // Add click listener to all product images
          document.querySelectorAll('.product').forEach(el => {
            el.addEventListener('click', event => {
              const cartUrl = event.target.dataset.cartUrl;
              window.open(cartUrl, '_blank');
            });
          });
        })
        .catch(error => console.error('Error loading products:', error));
    </script>
  </body>
</html>
