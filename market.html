<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>VR Market with A-Frame and Movement Controls</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <!-- A-Frame Extras para movement-controls y otros componentes -->
    <script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
  </head>
  <body>
    <a-scene>
      <!-- Rig para movimiento y controles VR -->
      <a-entity id="cameraRig" position="0 1.6 0" movement-controls="speed: 0.1">
        <!-- Cámara con look-controls y desplazamiento WASD -->
        <a-entity camera look-controls wasd-controls></a-entity>

        <!-- Cursor de fusión para gaze click en VR -->
        <a-entity cursor="fuse: true; fuseTimeout: 500" position="0 0 -1"
                  geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.02"
                  material="color: white; shader: flat"></a-entity>

        <!-- Laser controls para controladores VR -->
        <a-entity laser-controls="hand: left" raycaster="objects: .product"></a-entity>
        <a-entity laser-controls="hand: right" raycaster="objects: .product"></a-entity>
      </a-entity>

      <!-- Piso del mercado -->
      <a-plane rotation="-90 0 0" width="30" height="30" color="#7BC8A4"></a-plane>

      <!-- Contenedor de pasillos -->
      <a-entity id="market" position="-10 0 -10"></a-entity>
    </a-scene>

    <script>
      // Parámetros de diseño en inglés
      const NUM_AISLES    = 3;
      const AISLE_SPACING = 8;
      const AISLE_LENGTH  = 20;
      const ITEM_SPACING  = 1.2;
      const SHELF_HEIGHTS = [1.0, 1.8, 2.6];
      const SHEET_URL     = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQcDYcsgYBgMa6hvxzrh2dgaw9ane1kbjam1goRkV_9gRjXVERon5SUDmv1wZtS7ScFb4Ig_BMwu2yE/pub?output=tsv';

      // Carga y parseo de la hoja
      fetch(SHEET_URL)
        .then(res => res.text())
        .then(text => {
          const lines   = text.trim().split('\n');
          const headers = lines[0].split('\t');
          return lines.slice(1).map(line => {
            const cols = line.split('\t');
            const item = {};
            headers.forEach((header, i) => item[header] = cols[i]);
            return item;
          });
        })
        .then(products => {
          const marketEl = document.getElementById('market');

          for (let aisleIndex = 0; aisleIndex < NUM_AISLES; aisleIndex++) {
            const offsetX = aisleIndex * AISLE_SPACING;

            ['left', 'right'].forEach(side => {
              const direction  = side === 'left' ? -1 : 1;
              const shelfGroup = document.createElement('a-entity');
              shelfGroup.setAttribute('position', `${offsetX} 0 ${-AISLE_LENGTH/2}`);
              marketEl.appendChild(shelfGroup);

              SHELF_HEIGHTS.forEach(shelfY => {
                // Base de la repisa
                const shelf = document.createElement('a-box');
                shelf.setAttribute('width',  AISLE_LENGTH);
                shelf.setAttribute('height', 0.1);
                shelf.setAttribute('depth',  0.5);
                shelf.setAttribute('position', `${direction * 2.5} ${shelfY} 0`);
                shelf.setAttribute('color', '#CCCCCC');
                shelfGroup.appendChild(shelf);

                // Poblado de productos
                products.forEach((prod, index) => {
                  const colsPerShelf = Math.floor(AISLE_LENGTH / ITEM_SPACING);
                  const zPos = (index % colsPerShelf) * ITEM_SPACING - (AISLE_LENGTH/2) + ITEM_SPACING/2;
                  const xPos = direction * 2.5;

                  const img = document.createElement('a-image');
                  img.setAttribute('src', prod.Image_URL);
                  img.setAttribute('width', '0.8');
                  img.setAttribute('height', '0.8');
                  img.setAttribute('position', `${xPos} ${shelfY + 0.5} ${zPos}`);
                  img.className = 'product';
                  img.dataset.cartUrl = prod.AddToCart_URL;
                  shelfGroup.appendChild(img);

                  const titleText = document.createElement('a-text');
                  titleText.setAttribute('value', prod.Title);
                  titleText.setAttribute('width', '2');
                  titleText.setAttribute('position', `${xPos} ${shelfY - 0.1} ${zPos}`);
                  shelfGroup.appendChild(titleText);
                });
              });
            });
          }

          // Listener de click para añadir al carrito
          document.querySelectorAll('.product').forEach(el => {
            el.addEventListener('click', e => {
              window.open(e.target.dataset.cartUrl, '_blank');
            });
          });
        })
        .catch(err => console.error('Error loading products:', err));
    </script>
  </body>
</html>
